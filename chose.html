<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>物理抽獎 8.0 - 純淨競技版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --main: #00ffa2; --bg: #050505; }
        body { margin: 0; background: var(--bg); font-family: "PingFang TC", sans-serif; overflow: hidden; color: #eee; }
        
        /* 介面設計 */
        #ui-panel { position: fixed; left: 15px; top: 15px; width: 240px; max-height: 80vh; background: rgba(20,20,20,0.9); border-radius: 15px; padding: 20px; z-index: 100; border: 1px solid #333; backdrop-filter: blur(10px); overflow-y: auto; }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #1a1a1a; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        .player-row img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #555; }
        .player-row input { background: transparent; border: none; color: #fff; width: 100%; outline: none; font-size: 13px; }
        #btn-start { width: 100%; padding: 12px; background: var(--main); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        /* 即時排行榜 - 唯一的名稱顯示處 */
        #leaderboard { position: fixed; right: 15px; top: 15px; width: 200px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .rank-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; transition: all 0.3s ease; }
        .rank-item img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; }
        .rank-name { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-num { font-size: 18px; font-style: italic; color: var(--main); width: 20px; }

        /* 中獎彈窗 */
        #win-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 40px; border-radius: 30px; display: none; flex-direction: column; align-items: center; z-index: 200; text-align: center; box-shadow: 0 0 100px var(--main); }
        #win-popup img { width: 200px; height: 200px; border-radius: 50%; border: 6px solid var(--main); margin-bottom: 20px; }
        .btn-retry { padding: 12px 40px; background: #000; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; }

        /* 終點提示 */
        #goal-indicator {
            position: absolute;
            bottom: 20px; /* 相對於 render.canvas 的底部 */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(0, 255, 162, 0.8);
            color: #000;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            display: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #goal-indicator.active {
            opacity: 1;
            display: block;
        }

        /* 終點標誌圖片 */
        #goal-image {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px; /* 圖片大小 */
            height: auto;
            display: none; /* 預設隱藏 */
            z-index: 5;
            pointer-events: none; /* 不影響滑鼠事件 */
        }
    </style>
</head>
<body>

<div id="ui-panel">
    <h4 style="margin:0 0 15px 0; color:var(--main); letter-spacing: 1px;">物理抽獎 8.0</h4>
    <input type="file" id="file-input" multiple accept="image/*" style="font-size: 11px; margin-bottom: 15px;">
    <div id="list-area"></div>
    <button id="btn-start" disabled>確認照片並發射</button>
</div>

<div id="leaderboard">
    <div style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px;">LIVE RANKING</div>
    <div id="rank-list"></div>
</div>

<div id="win-popup">
    <h2 style="margin:0; color: #888; font-weight: 900;">FINAL WINNER</h2>
    <div id="win-avatar"></div>
    <h1 id="win-name" style="margin:10px 0; font-size: 42px;"></h1>
    <button class="btn-retry" onclick="retry()">重新開始</button>
</div>

<div id="goal-indicator">終點線！</div>
<img id="goal-image" src="https://i.imgur.com/G5g2B7w.png" alt="Finish Line"> <script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body, Vector } = Matter;
let W, H = 10000, BALL_R = 28; // W 會根據視窗寬度調整
let engine, render, runner, players = [], isGaming = false;
let goalIndicatorVisible = false;

function init() {
    // 根據視窗寬度調整遊戲寬度，手機模式會更窄
    W = Math.min(600, window.innerWidth * 0.9); 
    if (window.innerWidth < 768) { // 假設手機寬度小於768px
        BALL_R = 20; // 手機上球可以小一點
        document.getElementById('ui-panel').style.width = 'calc(100% - 30px)';
        document.getElementById('ui-panel').style.left = '15px';
        document.getElementById('ui-panel').style.top = '15px';
        document.getElementById('leaderboard').style.width = '120px'; // 排行榜也小一點
        document.getElementById('leaderboard').style.right = '15px';
        document.getElementById('leaderboard').style.top = '15px';
    }


    engine = Engine.create();
    render = Render.create({
        element: document.body,
        engine: engine,
        options: { 
            width: W, 
            height: window.innerHeight, 
            wireframes: false, 
            background: '#050505', 
            hasBounds: true, 
            pixelRatio: window.devicePixelRatio || 1 // 根據設備像素比渲染
        }
    });

    // 調整 render canvas 的位置，讓它置中
    render.canvas.style.position = 'absolute';
    render.canvas.style.left = '50%';
    render.canvas.style.transform = 'translateX(-50%)';

    const obs = [];
    const blockColor = '#1a1a1a';
    
    // --- 結構化防卡死地圖設計 ---
    for (let y = 600; y < H - 800; y += 400) {
        const type = Math.floor(Math.random() * 6); // 增加更多類型
        
        if (type === 0) { // 擺動大斜板 - 絕對不卡球
            const x = W/2 + (Math.random()*100 - 50);
            const plank = Bodies.rectangle(x, y, 350, 25, { chamfer: { radius: 12 }, render: { fillStyle: '#333' } });
            const pivot = Constraint.create({ pointA: { x: x, y: y }, bodyB: plank, stiffness: 0.1 });
            obs.push(plank, pivot);
        } else if (type === 1) { // 旋轉十字星
            const x = (y % 800 === 0) ? W * 0.25 : W * 0.75;
            const star = Bodies.rectangle(x, y, 220, 20, { chamfer: { radius: 10 }, render: { fillStyle: '#ff4b2b' } });
            const p = Constraint.create({ pointA: { x: x, y: y }, bodyB: star, stiffness: 1 });
            obs.push(star, p);
            Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(star, 0.06));
        } else if (type === 2) { // 兩側斜導向滑塊
            obs.push(
                Bodies.rectangle(W * 0.2, y, 300, 30, { isStatic: true, angle: 0.5, render: { fillStyle: blockColor } }),
                Bodies.rectangle(W * 0.8, y, 300, 30, { isStatic: true, angle: -0.5, render: { fillStyle: blockColor } })
            );
        } else if (type === 3) { // 彈性蹦床
            const x = W/2 + (Math.random()*100 - 50);
            obs.push(Bodies.rectangle(x, y, 200, 15, { isStatic: true, restitution: 0.9, render: { fillStyle: '#00ccff' } }));
        } else if (type === 4) { // 移動平台
            const platform = Bodies.rectangle(W * 0.25, y, 250, 20, { isStatic: true, render: { fillStyle: '#ffcc00' } });
            obs.push(platform);
            Events.on(engine, 'beforeUpdate', () => {
                const time = engine.timing.timestamp * 0.002;
                const targetX = W * 0.25 + Math.sin(time) * (W * 0.25);
                Body.setPosition(platform, { x: targetX, y: platform.position.y });
            });
        } else if (type === 5) { // 小型齒輪陣
            const startX = W * 0.2;
            const numGears = Math.floor(W / 100);
            for (let i = 0; i < numGears; i++) {
                const gear = Bodies.polygon(startX + i * (W / numGears), y, 6, 20, { isStatic: true, render: { fillStyle: '#888' } });
                obs.push(gear);
                Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(gear, 0.04 * (i % 2 === 0 ? 1 : -1)));
            }
        }
    }

    // 終點前漏斗 - 已加大開口防止卡球
    obs.push(
        // 左側板：往左移 (從150變100)，角度調平一點 (從0.7變0.5)
        Bodies.rectangle(W * 0.25, H-500, W * 0.5, 40, { isStatic: true, angle: 0.5, render: { fillStyle: '#fff' } }),
        // 右側板：往右移 (從450變500)，角度調平一點 (從-0.7變-0.5)
        Bodies.rectangle(W * 0.75, H-500, W * 0.5, 40, { isStatic: true, angle: -0.5, render: { fillStyle: '#fff' } })
    );

    const walls = [
        Bodies.rectangle(-20, H/2, 40, H, { isStatic: true, render: { fillStyle: '#111' } }),
        Bodies.rectangle(W+20, H/2, 40, H, { isStatic: true, render: { fillStyle: '#111' } }),
        Bodies.rectangle(W/2, H+50, W, 100, { isStatic: true, label: 'goal', render: { fillStyle: varGet('--main') } })
    ];

    Composite.add(engine.world, [...walls, ...obs]);
    Render.run(render);
    Runner.run(Runner.create(), engine);

    Events.on(render, 'afterRender', () => {
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
        if (!balls.length) return;

        const sorted = [...balls].sort((a, b) => b.position.y - a.position.y);
        updateUI(sorted.slice(0, 3));

        // 鏡頭鎖定
        const lead = sorted[0];
        const vh = render.options.height;
        let ty = Math.min(Math.max(0, lead.position.y - vh * 0.4), H - vh);
        render.bounds.min.y = ty; render.bounds.max.y = ty + vh;
        render.bounds.min.x = 0; render.bounds.max.x = W;

        // 終點提示
        const goalPos = H - 50; // 終點y座標
        const currentViewBottom = ty + vh;
        const goalIndicator = document.getElementById('goal-indicator');
        const goalImage = document.getElementById('goal-image');

        if (currentViewBottom >= goalPos - 300 && !goalIndicatorVisible) { // 距離終點300px時顯示
            goalIndicatorVisible = true;
            goalIndicator.classList.add('active');
            goalImage.style.display = 'block';
            
            // 讓終點旗幟圖片跟隨鏡頭，固定在終點上方
            goalImage.style.top = `${goalPos - render.bounds.min.y - 200}px`; // 圖片在終點上方200px
            
            // 終點閃爍動畫
            let flashInterval = setInterval(() => {
                const goalBody = Composite.allBodies(engine.world).find(b => b.label === 'goal');
                if (goalBody) {
                    goalBody.render.fillStyle = goalBody.render.fillStyle === varGet('--main') ? '#ffdd00' : varGet('--main');
                }
            }, 300);

            setTimeout(() => { // 提示顯示一段時間後消失
                goalIndicator.classList.remove('active');
                goalImage.style.display = 'none';
                clearInterval(flashInterval);
            }, 3000);
        } else if (currentViewBottom < goalPos - 300) {
            goalIndicatorVisible = false;
        }

        // 更新終點旗幟的Y位置，使其相對於遊戲世界的終點線
        if (goalImage.style.display === 'block') {
             goalImage.style.top = `${goalPos - render.bounds.min.y - 200}px`;
        }
    });

    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            if ((p.bodyA.label === 'goal' || p.bodyB.label === 'goal') && isGaming) {
                const b = p.bodyA.label === 'p' ? p.bodyA : (p.bodyB.label === 'p' ? p.bodyB : null);
                if (b) finish(b);
            }
        });
    });
}

function updateUI(top) {
    const list = document.getElementById('rank-list');
    list.innerHTML = top.map((b, i) => `
        <div class="rank-item">
            <span class="rank-num">${i+1}</span>
            <img src="${b.pUrl}">
            <div class="rank-name">${b.pName}</div>
        </div>
    `).join('');
}

async function prepImg(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = c.height = 400;
                const x = c.getContext('2d');
                x.imageSmoothingEnabled = true;
                x.imageSmoothingQuality = 'high';
                x.beginPath(); x.arc(200, 200, 195, 0, Math.PI*2); x.clip();
                const s = Math.max(400/img.width, 400/img.height);
                x.drawImage(img, (400-img.width*s)/2, (400-img.height*s)/2, img.width*s, img.height*s);
                x.strokeStyle = "#fff"; x.lineWidth = 10; x.stroke();
                res(c.toDataURL());
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    });
}

document.getElementById('file-input').addEventListener('change', async (e) => {
    const fs = Array.from(e.target.files);
    const area = document.getElementById('list-area');
    for (let f of fs) {
        const url = await prepImg(f);
        const id = Math.random(), name = f.name.split('.')[0];
        players.push({ id, url, name });
        const d = document.createElement('div');
        d.className = 'player-row';
        d.innerHTML = `<img src="${url}"><input type="text" value="${name}" oninput="players.find(p=>p.id===${id}).name=this.value">`;
        area.appendChild(d);
    }
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').innerText = "釋放選手！";
});

document.getElementById('btn-start').addEventListener('click', () => {
    isGaming = true;
    document.getElementById('ui-panel').style.display = 'none';
    players.forEach((p, i) => {
        const b = Bodies.circle(W/2 + (Math.random()*40-20), 100 - (i*80), BALL_R, {
            restitution: 0.5, friction: 0.001, label: 'p',
            render: { sprite: { texture: p.url, xScale: (BALL_R*2)/400, yScale: (BALL_R*2)/400 } }
        });
        b.pName = p.name; b.pUrl = p.url;
        Composite.add(engine.world, b);
    });
});

function finish(b) {
    isGaming = false;
    const pop = document.getElementById('win-popup');
    document.getElementById('win-avatar').innerHTML = `<img src="${b.pUrl}">`;
    document.getElementById('win-name').innerText = b.pName;
    pop.style.display = 'flex';
}

function retry() {
    const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
    Composite.remove(engine.world, balls);
    document.getElementById('win-popup').style.display = 'none';
    document.getElementById('ui-panel').style.display = 'block';
    isGaming = false;
    goalIndicatorVisible = false; // 重置提示狀態
    document.getElementById('goal-indicator').classList.remove('active');
    document.getElementById('goal-image').style.display = 'none';

    // 重置終點顏色
    const goalBody = Composite.allBodies(engine.world).find(b => b.label === 'goal');
    if (goalBody) {
        goalBody.render.fillStyle = varGet('--main');
    }
}

function varGet(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }

init();
window.addEventListener('resize', () => {
    // 當視窗大小改變時重新初始化，以適應手機旋轉等
    if (render) Render.stop(render);
    if (runner) Runner.stop(runner);
    Composite.clear(engine.world);
    Engine.clear(engine);
    init();
});
</script>
</body>
</html>
