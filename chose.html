<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>物理抽獎 13.0 - IG 最終修復版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --main: #00ffa2; --bg: #050505; }
        body { margin: 0; background: var(--bg); font-family: "PingFang TC", sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; color: #eee; }
        
        #ui-panel { position: fixed; left: 10px; top: 10px; width: calc(100% - 130px); max-height: 45vh; background: rgba(25,25,25,0.95); border-radius: 15px; padding: 15px; z-index: 100; border: 1px solid #444; backdrop-filter: blur(10px); overflow-y: auto; }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #1a1a1a; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        .player-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #555; background: #222; }
        .player-row input { background: transparent; border: none; color: #fff; width: 100%; font-size: 13px; outline: none; }
        #btn-start { width: 100%; padding: 12px; background: var(--main); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        
        #leaderboard { position: fixed; right: 10px; top: 10px; width: 100px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .rank-item { display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; position: relative; }
        .rank-item img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--main); object-fit: cover; }
        .rank-badge { position: absolute; top: -5px; left: 5px; background: var(--main); color: #000; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; border: 1px solid #000; }
        .rank-name { font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; margin-top: 3px; color: #fff; }

        #win-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 25px; display: none; flex-direction: column; align-items: center; z-index: 200; width: 75%; text-align: center; box-shadow: 0 0 80px var(--main); }
        #win-popup img { width: 160px; height: 160px; border-radius: 50%; border: 6px solid var(--main); object-fit: cover; margin-bottom: 15px; }
        .btn-retry { padding: 12px 30px; background: #000; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #add-player { margin-bottom: 10px; background: #333; color: #fff; border: 1px dashed #666; width: 100%; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div style="font-size: 16px; color: var(--main); margin-bottom: 12px; font-weight: bold; text-align: center;">物理抽獎 13.0</div>
    <input type="file" id="file-input" multiple accept="image/*" style="font-size: 12px; margin-bottom: 12px; width: 100%;">
    <button id="add-player">+ 手動新增 / 貼上 IG 連結</button>
    <div id="list-area"></div>
    <button id="btn-start" disabled>確認名單並發射！</button>
</div>

<div id="leaderboard">
    <div id="rank-list"></div>
</div>

<div id="win-popup">
    <h2 style="margin:0; font-size: 18px; color: #666; font-weight: 900;">恭喜優勝者！</h2>
    <div id="win-avatar"></div>
    <h1 id="win-name" style="margin:5px 0 25px 0; font-size: 32px;"></h1>
    <button class="btn-retry" onclick="resetGame()">重新挑戰</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body } = Matter;
const W = 400, H = 10000;
let BALL_R = 22, engine, render, runner, players = [], isGaming = false;

// 關鍵修復：改用魔術代理服務
const GET_AVATAR = (user) => `https://wsrv.nl/?url=https://unavatar.io/instagram/${user}&w=200&h=200&mask=circle&output=png`;

function init() {
    engine = Engine.create();
    render = Render.create({
        element: document.body, engine: engine,
        options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: '#050505', hasBounds: true }
    });

    const obs = [];
    const SAFE_GAP = BALL_R * 2.5;

    // 隨機障礙物邏輯
    for (let y = 500; y < H - 1000; y += 350) {
        const type = Math.floor(Math.random() * 6);
        const x = SAFE_GAP + Math.random() * (W - 2 * SAFE_GAP);
        if (type === 0) obs.push(Bodies.circle(x, y, 40, { isStatic: true, render: { fillStyle: '#111', strokeStyle: '#00ffa2', lineWidth: 3 } }));
        else if (type === 1) {
            const star = Bodies.rectangle(W/2, y, 160, 15, { isStatic: false, render: { fillStyle: '#ff4b2b' } });
            obs.push(star, Constraint.create({ pointA: { x: W/2, y: y }, bodyB: star, stiffness: 1 }));
            Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(star, 0.08));
        } else if (type === 2) {
            const tri = Bodies.polygon(x, y, 3, 45, { isStatic: true, render: { fillStyle: '#9c27b0' } });
            obs.push(tri);
            Events.on(engine, 'beforeUpdate', () => Body.setAngle(tri, tri.angle + 0.05));
        } else {
            obs.push(Bodies.circle(x, y, 15, { isStatic: true, render: { fillStyle: '#555' } }));
        }
    }

    const goal = Bodies.rectangle(W/2, H+50, W, 120, { isStatic: true, label: 'goal', render: { fillStyle: '#00ffa2' } });
    Composite.add(engine.world, [
        Bodies.rectangle(-22, H/2, 45, H, { isStatic: true }), 
        Bodies.rectangle(W+22, H/2, 45, H, { isStatic: true }), 
        goal, ...obs
    ]);

    Render.run(render);
    Runner.run(Runner.create(), engine);

    Events.on(render, 'afterRender', () => {
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
        if (!balls.length) return;
        const sorted = [...balls].sort((a, b) => b.position.y - a.position.y);
        document.getElementById('rank-list').innerHTML = sorted.slice(0, 3).map((b, i) => `
            <div class="rank-item"><div class="rank-badge">${i+1}</div><img src="${b.pUrl}"><div class="rank-name">${b.pName}</div></div>
        `).join('');
        const vh = render.options.height;
        let ty = Math.min(Math.max(0, sorted[0].position.y - vh/2), H - vh);
        render.bounds.min.y = ty; render.bounds.max.y = ty + vh;
    });

    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            if ((p.bodyA.label === 'goal' || p.bodyB.label === 'goal') && isGaming) {
                const b = p.bodyA.label === 'p' ? p.bodyA : (p.bodyB.label === 'p' ? p.bodyB : null);
                if (b) { isGaming = false; showWin(b); }
            }
        });
    });
}

// 這是讓圖片「合法化」的關鍵：將代理網址畫到畫布上，變成 DataURL
async function getSecureImage(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; 
        img.onload = () => {
            const c = document.createElement('canvas');
            c.width = c.height = 200;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0, 200, 200);
            resolve(c.toDataURL());
        };
        img.onerror = () => resolve("https://www.gravatar.com/avatar/0?d=mp");
        img.src = url;
    });
}

async function handlePlayerInput(el, id) {
    const val = el.value.trim();
    const player = players.find(p => p.id === id);
    if (val.includes('instagram.com')) {
        const username = val.split('instagram.com/')[1]?.split('/')[0]?.split('?')[0];
        if (username) {
            el.value = "處理中...";
            const proxyUrl = GET_AVATAR(username);
            const finalDataUrl = await getSecureImage(proxyUrl);
            player.url = finalDataUrl;
            player.name = username;
            el.value = username;
            document.querySelector(`img[data-id="${id}"]`).src = finalDataUrl;
        }
    } else { player.name = val; }
}

function addPlayerRow(id, url = "https://www.gravatar.com/avatar/0?d=mp", name = "") {
    const d = document.createElement('div');
    d.className = 'player-row';
    d.innerHTML = `<img src="${url}" data-id="${id}"><input type="text" value="${name}" data-id="${id}" placeholder="貼上 IG 連結" oninput="handlePlayerInput(this, ${id})">`;
    document.getElementById('list-area').appendChild(d);
    document.getElementById('btn-start').disabled = false;
}

document.getElementById('add-player').addEventListener('click', () => {
    const id = Math.random();
    players.push({ id, url: "https://www.gravatar.com/avatar/0?d=mp", name: "" });
    addPlayerRow(id);
});

document.getElementById('file-input').addEventListener('change', async (e) => {
    for (let f of Array.from(e.target.files)) {
        const r = new FileReader();
        r.onload = (ev) => {
            const id = Math.random();
            players.push({ id, url: ev.target.result, name: f.name.split('.')[0] });
            addPlayerRow(id, ev.target.result, f.name.split('.')[0]);
        };
        r.readAsDataURL(f);
    }
});

document.getElementById('btn-start').addEventListener('click', () => {
    isGaming = true; document.getElementById('ui-panel').style.display = 'none';
    const spacingX = BALL_R * 2.2, ballsPerRow = Math.floor((W - 40) / spacingX);
    players.forEach((p, i) => {
        const row = Math.floor(i / ballsPerRow), col = i % ballsPerRow;
        const startX = (W - (Math.min(players.length, ballsPerRow) * spacingX)) / 2 + (spacingX / 2);
        const b = Bodies.circle(startX + col * spacingX, 100 - (row * 60), BALL_R, {
            restitution: 0.5, friction: 0.01, label: 'p',
            render: { sprite: { texture: p.url, xScale: (BALL_R*2)/200, yScale: (BALL_R*2)/200 } }
        });
        b.pName = p.name || "匿名者"; b.pUrl = p.url;
        Composite.add(engine.world, b);
    });
});

function showWin(b) {
    document.getElementById('win-avatar').innerHTML = `<img src="${b.pUrl}">`;
    document.getElementById('win-name').innerText = b.pName;
    document.getElementById('win-popup').style.display = 'flex';
}

function resetGame() {
    location.reload(); // 重新整理最保險
}

init();
</script>
</body>
</html>
