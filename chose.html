<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰©ç†æŠ½ç 14.0 - æ—‹è½‰å¤§äº‚é¬¥ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --main: #00ffa2; --bg: #050505; }
        body { margin: 0; background: var(--bg); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; color: #eee; }
        
        #ui-panel { position: fixed; left: 10px; top: 10px; width: calc(100% - 130px); max-height: 45vh; background: rgba(25,25,25,0.95); border-radius: 15px; padding: 15px; z-index: 100; border: 1px solid #444; backdrop-filter: blur(10px); overflow-y: auto; }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #1a1a1a; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        .player-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .player-row input { background: transparent; border: none; color: #fff; width: 100%; font-size: 13px; outline: none; }
        
        #btn-start { width: 100%; padding: 12px; background: var(--main); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; box-shadow: 0 0 15px rgba(0,255,162,0.4); }
        #btn-start:disabled { background: #444; color: #888; cursor: not-allowed; box-shadow: none; }
        
        #leaderboard { position: fixed; right: 10px; top: 10px; width: 80px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; }
        .rank-item { position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; }
        .rank-item img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #555; object-fit: cover; }
        .rank-badge { position: absolute; top: -5px; left: -5px; width: 22px; height: 22px; background: var(--main); color: #000; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #000; }
        .rank-name { font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; margin-top: 4px; }

        #win-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 25px; display: none; flex-direction: column; align-items: center; z-index: 200; width: 75%; text-align: center; box-shadow: 0 0 80px var(--main); }
        #win-popup img { width: 160px; height: 160px; border-radius: 50%; border: 6px solid var(--main); object-fit: cover; margin-bottom: 15px; }
        .btn-retry { padding: 12px 30px; background: #000; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div style="font-size: 16px; color: var(--main); margin-bottom: 12px; font-weight: bold; text-align: center;">ç‰©ç†æŠ½ç 14.0 - æ—‹è½‰èµ·è·‘</div>
    <input type="file" id="file-input" multiple accept="image/*" style="font-size: 12px; margin-bottom: 12px; width: 100%;">
    <div id="list-area"></div>
    <button id="btn-start" disabled>æº–å‚™åå–®</button>
</div>

<div id="leaderboard">
    <div style="font-size: 9px; color:#888; text-align:center; margin-bottom:10px;">RANKING</div>
    <div id="rank-list"></div>
</div>

<div id="win-popup">
    <h2 style="margin:0; font-size: 18px; color: #666;">ğŸ‰ æ­å–œå„ªå‹è€…ï¼</h2>
    <div id="win-avatar"></div>
    <h1 id="win-name" style="margin:5px 0 25px 0; font-size: 32px;"></h1>
    <button class="btn-retry" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body, Vertices } = Matter;
const W = 400, H = 10000;
let BALL_R = 20, engine, render, runner, players = [], isGaming = false, isReleased = false;
let containerParts = [];

function init() {
    engine = Engine.create();
    render = Render.create({
        element: document.body,
        engine: engine,
        options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: '#050505', hasBounds: true }
    });

    // ç‰†å£èˆ‡éšœç¤™
    const obs = [];
    for (let y = 600; y < H; y += 180) {
        const r = 15 + Math.random() * 20;
        obs.push(
            Bodies.circle(0, y, r, { isStatic: true, render: { fillStyle: '#222' } }),
            Bodies.circle(W, y + 90, r, { isStatic: true, render: { fillStyle: '#222' } })
        );
    }

    // éš¨æ©Ÿæ©Ÿé—œ
    for (let y = 1000; y < H - 1000; y += 400) {
        const x = 100 + Math.random() * (W - 200);
        const poly = Bodies.polygon(x, y, Math.floor(Math.random()*3)+3, 40, { isStatic: true, render: { fillStyle: '#333' } });
        obs.push(poly);
        Events.on(engine, 'beforeUpdate', () => Body.setAngle(poly, poly.angle + 0.02));
    }

    const goal = Bodies.rectangle(W/2, H+50, W, 120, { isStatic: true, label: 'goal', render: { fillStyle: '#00ffa2' } });
    Composite.add(engine.world, [
        Bodies.rectangle(-22, H/2, 45, H, { isStatic: true, render: { fillStyle: '#000' } }),
        Bodies.rectangle(W+22, H/2, 45, H, { isStatic: true, render: { fillStyle: '#000' } }),
        goal, ...obs
    ]);

    Render.run(render);
    Runner.run(Runner.create(), engine);

    // è¦–è§’è·Ÿéš¨èˆ‡æ’è¡Œ
    Events.on(render, 'afterRender', () => {
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
        if (!balls.length) return;
        const sorted = [...balls].sort((a, b) => b.position.y - a.position.y);
        
        // æ›´æ–°æ’è¡Œ
        document.getElementById('rank-list').innerHTML = sorted.slice(0, 3).map((b, i) => `
            <div class="rank-item">
                <div class="rank-badge">${i + 1}</div>
                <img src="${b.pUrl}">
                <div class="rank-name">${b.pName}</div>
            </div>
        `).join('');

        // ç›¸æ©Ÿé‚è¼¯ï¼šé‡‹æ”¾å‰çœ‹è‘—å®¹å™¨ï¼Œé‡‹æ”¾å¾Œè·Ÿè‘—ç¬¬ä¸€å
        const vh = render.options.height;
        let targetY = isReleased ? sorted[0].position.y - vh/3 : 50;
        let ty = Math.min(Math.max(0, targetY), H - vh);
        render.bounds.min.y = ty; render.bounds.max.y = ty + vh;
    });

    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            const labels = [p.bodyA.label, p.bodyB.label];
            if (labels.includes('goal') && isReleased) {
                const b = p.bodyA.label === 'p' ? p.bodyA : (p.bodyB.label === 'p' ? p.bodyB : null);
                if (b && isGaming) { isGaming = false; showWin(b); }
            }
        });
    });
}

// å»ºç«‹æ—‹è½‰å¤§å®¹å™¨
function createContainer() {
    const segments = 24;
    const radius = 120;
    const cx = W / 2, cy = 250;
    
    for (let i = 0; i < segments; i++) {
        const angle = (i / segments) * Math.PI * 2;
        const part = Bodies.rectangle(
            cx + Math.cos(angle) * radius,
            cy + Math.sin(angle) * radius,
            40, 10, {
                isStatic: true,
                angle: angle + Math.PI / 2,
                render: { fillStyle: 'rgba(0, 255, 162, 0.2)', strokeStyle: '#00ffa2', lineWidth: 2 }
            }
        );
        containerParts.push(part);
    }
    Composite.add(engine.world, containerParts);

    // ä½¿å®¹å™¨æ—‹è½‰
    Events.on(engine, 'beforeUpdate', () => {
        if (isReleased) return;
        const time = engine.timing.timestamp * 0.005;
        containerParts.forEach((part, i) => {
            const angle = (i / segments) * Math.PI * 2 + time;
            Body.setPosition(part, {
                x: cx + Math.cos(angle) * radius,
                y: cy + Math.sin(angle) * radius
            });
            Body.setAngle(part, angle + Math.PI / 2);
        });
    });
}

async function prepImg(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = c.height = 300;
                const x = c.getContext('2d');
                x.beginPath(); x.arc(150, 150, 150, 0, Math.PI*2); x.clip();
                x.drawImage(img, 0, 0, img.width, img.height, 0, 0, 300, 300);
                res(c.toDataURL());
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    });
}

document.getElementById('file-input').addEventListener('change', async (e) => {
    for (let f of Array.from(e.target.files)) {
        const url = await prepImg(f), name = f.name.split('.')[0], id = Math.random();
        players.push({ id, url, name });
        const d = document.createElement('div');
        d.className = 'player-row';
        d.innerHTML = `<img src="${url}"><input type="text" value="${name}" oninput="players.find(p=>p.id===${id}).name=this.value">`;
        document.getElementById('list-area').appendChild(d);
    }
    document.getElementById('btn-start').disabled = false;
});

document.getElementById('btn-start').addEventListener('click', () => {
    const btn = document.getElementById('btn-start');
    
    if (!isGaming && !isReleased) {
        // ç¬¬ä¸€éšæ®µï¼šæ”¾å…¥çƒä¸¦æ—‹è½‰
        isGaming = true;
        createContainer();
        players.forEach((p, i) => {
            const b = Bodies.circle(W/2 + (Math.random()-0.5)*50, 250 + (Math.random()-0.5)*50, BALL_R, {
                restitution: 0.8, friction: 0.001, label: 'p',
                render: { sprite: { texture: p.url, xScale: (BALL_R*2)/300, yScale: (BALL_R*2)/300 } }
            });
            b.pName = p.name; b.pUrl = p.url;
            Composite.add(engine.world, b);
        });
        btn.innerText = "ğŸ”¥ é‡‹æ”¾ä¸¦é–‹å§‹æ¯”è³½ï¼";
        btn.style.background = "#ff4b2b";
    } else {
        // ç¬¬äºŒéšæ®µï¼šçˆ†ç‚¸é‡‹æ”¾
        isReleased = true;
        Composite.remove(engine.world, containerParts);
        document.getElementById('ui-panel').style.opacity = '0';
        setTimeout(() => document.getElementById('ui-panel').style.display = 'none', 500);
        
        // çµ¦å°çƒä¸€å€‹éš¨æ©Ÿåˆå§‹è¡åŠ›
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
        balls.forEach(b => {
            Body.applyForce(b, b.position, { x: (Math.random()-0.5)*0.05, y: 0.05 });
        });
    }
});

function showWin(b) {
    document.getElementById('win-avatar').innerHTML = `<img src="${b.pUrl}">`;
    document.getElementById('win-name').innerText = b.pName;
    document.getElementById('win-popup').style.display = 'flex';
}

init();
</script>
</body>
</html>
