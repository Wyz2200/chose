<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰©ç†æŠ½ç 13.5 - é‡æ©Ÿé—œç‰ˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
:root { --main:#00ffa2; --bg:#050505; }
body{margin:0;background:var(--bg);overflow:hidden;font-family:"PingFang TC";}
#ui-panel{position:fixed;left:10px;top:10px;width:calc(100%-130px);background:#111;padding:15px;border-radius:15px;z-index:10}
.player-row{display:flex;gap:8px;margin-bottom:6px}
.player-row img{width:36px;height:36px;border-radius:50%}
#leaderboard{position:fixed;right:10px;top:10px;width:90px;background:#000a;padding:10px;border-radius:15px}
.rank-item{position:relative;text-align:center;margin-bottom:10px}
.rank-item img{width:50px;height:50px;border-radius:50%}
.rank-badge{position:absolute;top:-5px;left:-5px;width:22px;height:22px;background:var(--main);border-radius:50%;font-size:12px;font-weight:bold}
#win-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:30px;border-radius:25px;display:none;z-index:20}
#win-popup img{width:160px;height:160px;border-radius:50%}
</style>
</head>

<body>

<div id="ui-panel">
<input type="file" id="file-input" multiple accept="image/*"><br><br>
<div id="list-area"></div>
<button id="btn-start" disabled>ç¢ºèªåå–®ä¸¦ç™¼å°„</button>
</div>

<div id="leaderboard"><div id="rank-list"></div></div>

<div id="win-popup">
<img id="win-img">
<h1 id="win-name"></h1>
<button onclick="resetGame()">å†ä¾†ä¸€æ¬¡</button>
</div>

<script>
const {Engine,Render,Runner,Bodies,Composite,Events,Body,Constraint} = Matter;
const W=400,H=9000,BALL_R=22;
let engine,render,isGaming=false,players=[];

function init(){
engine=Engine.create();
render=Render.create({
element:document.body,
engine,
options:{width:innerWidth,height:innerHeight,wireframes:false,background:"#050505",hasBounds:true}
});

const obs=[];

/* é‚Šç•Œ */
obs.push(
Bodies.rectangle(-20,H/2,40,H,{isStatic:true}),
Bodies.rectangle(W+20,H/2,40,H,{isStatic:true})
);

/* åŠæœˆç‰† */
for(let y=400;y<H;y+=160){
obs.push(
Bodies.circle(0,y,18,{isStatic:true}),
Bodies.circle(W,y+80,18,{isStatic:true})
);
}

/* é‡æ©Ÿé—œå€ */
for(let y=700;y<H-800;y+=320){
const t=Math.floor(Math.random()*10);
const cx=W/2;
const safeX=80+Math.random()*(W-160);

/* åŸæœ‰ */
if(t===0){
const r=Bodies.circle(safeX,y,34,{isStatic:true});
obs.push(r);
Events.on(engine,"beforeUpdate",()=>Body.rotate(r,0.15));
}
else if(t===1){
const a=Bodies.rectangle(cx-90,y,100,14,{isStatic:true});
const b=Bodies.rectangle(cx+90,y,100,14,{isStatic:true});
obs.push(a,b);
Events.on(engine,"beforeUpdate",()=>{
const m=Math.sin(engine.timing.timestamp*0.003)*60;
Body.setPosition(a,{x:cx-120+m,y});
Body.setPosition(b,{x:cx+120-m,y});
});
}
else if(t===2){
const star=Bodies.rectangle(cx,y,170,14);
obs.push(star,Constraint.create({pointA:{x:cx,y},bodyB:star}));
Events.on(engine,"beforeUpdate",()=>Body.setAngularVelocity(star,0.1));
}

/* æ–°å¢ âœ‚ å‰ªåˆ€é–€ */
else if(t===3){
const l=Bodies.rectangle(130,y,160,14,{isStatic:true,angle:0.6});
const r=Bodies.rectangle(270,y,160,14,{isStatic:true,angle:-0.6});
obs.push(l,r);
Events.on(engine,"beforeUpdate",()=>{
const s=Math.sin(engine.timing.timestamp*0.002)*0.4;
Body.setAngle(l,0.6+s);
Body.setAngle(r,-0.6-s);
});
}

/* æ–°å¢ ğŸ¥ å½ˆè·³é¼“ */
else if(t===4){
obs.push(Bodies.circle(safeX,y,28,{isStatic:true,restitution:2.8}));
}

/* æ–°å¢ âš™ é›™æ—‹è¼ª */
else if(t===5){
const c1=Bodies.circle(cx-60,y,26,{isStatic:true});
const c2=Bodies.circle(cx+60,y,26,{isStatic:true});
obs.push(c1,c2);
Events.on(engine,"beforeUpdate",()=>{
Body.rotate(c1,0.12);
Body.rotate(c2,-0.12);
});
}

/* æ–°å¢ ğŸš§ å‡é™é–€ */
else if(t===6){
const gate=Bodies.rectangle(cx,y,220,16,{isStatic:true});
obs.push(gate);
Events.on(engine,"beforeUpdate",()=>{
Body.setPosition(gate,{x:cx,y:y+Math.sin(engine.timing.timestamp*0.002)*40});
});
}

/* æ–°å¢ ğŸŒª æ¼©æ¸¦ */
else if(t===7){
const v=Bodies.circle(cx,y,40,{isStatic:true});
obs.push(v);
Events.on(engine,"beforeUpdate",()=>{
Composite.allBodies(engine.world).forEach(b=>{
if(b.label==="p"){
const dx=v.position.x-b.position.x;
const dy=v.position.y-b.position.y;
const d=Math.sqrt(dx*dx+dy*dy);
if(d<120){
Body.applyForce(b,b.position,{x:dx*0.000002,y:dy*0.000002});
}
}
});
});
}
}

/* çµ‚é» */
const goal=Bodies.rectangle(W/2,H+50,W,120,{isStatic:true,label:"goal"});
Composite.add(engine.world,[...obs,goal]);

Render.run(render);
Runner.run(Runner.create(),engine);

/* æ’å & æ”å½±æ©Ÿ */
Events.on(render,"afterRender",()=>{
const balls=Composite.allBodies(engine.world).filter(b=>b.label==="p");
if(!balls.length)return;
balls.sort((a,b)=>b.position.y-a.position.y);
document.getElementById("rank-list").innerHTML=
balls.slice(0,3).map((b,i)=>`<div class="rank-item"><div class="rank-badge">${i+1}</div><img src="${b.url}"></div>`).join("");
const vh=render.options.height;
render.bounds.min.y=Math.min(Math.max(0,balls[0].position.y-vh/2),H-vh);
render.bounds.max.y=render.bounds.min.y+vh;
});

/* ç²å‹ */
Events.on(engine,"collisionStart",e=>{
e.pairs.forEach(p=>{
if((p.bodyA.label==="goal"||p.bodyB.label==="goal")&&isGaming){
const b=p.bodyA.label==="p"?p.bodyA:p.bodyB.label==="p"?p.bodyB:null;
if(b){isGaming=false;showWin(b);}
}
});
});
}

document.getElementById("file-input").onchange=async e=>{
for(const f of e.target.files){
const url=URL.createObjectURL(f);
players.push({name:f.name.split(".")[0],url});
document.getElementById("list-area").innerHTML+=
`<div class="player-row"><img src="${url}"><span>${f.name}</span></div>`;
}
document.getElementById("btn-start").disabled=false;
};

document.getElementById("btn-start").onclick=()=>{
isGaming=true;
players.forEach((p,i)=>{
const b=Bodies.circle(W/2+(i%5-2)*50,100-Math.floor(i/5)*50,BALL_R,{
label:"p",restitution:0.5,render:{sprite:{texture:p.url,xScale:0.15,yScale:0.15}}
});
b.url=p.url;b.name=p.name;
Composite.add(engine.world,b);
});
};

function showWin(b){
document.getElementById("win-img").src=b.url;
document.getElementById("win-name").innerText=b.name;
document.getElementById("win-popup").style.display="block";
}

function resetGame(){
Composite.clear(engine.world,false);
document.getElementById("win-popup").style.display="none";
isGaming=false;
init();
}

init();
</script>
</body>
</html>
