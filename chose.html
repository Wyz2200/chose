<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜è³ªæ„Ÿç‰©ç†æŠ½ç 3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; overflow: hidden; color: white; }
        
        /* å´é‚Šç·¨è¼¯é¢æ¿ */
        #ui-panel {
            position: fixed; left: 10px; top: 10px; width: 280px; max-height: 90vh;
            background: rgba(30, 30, 30, 0.95); border-radius: 15px; padding: 20px;
            z-index: 100; overflow-y: auto; border: 1px solid #444; backdrop-filter: blur(10px);
        }
        .player-item { display: flex; align-items: center; margin: 10px 0; background: #333; padding: 5px; border-radius: 8px; }
        .player-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .player-item input { background: transparent; border: 1px solid #555; color: white; padding: 5px; width: 150px; }

        #start-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #start-btn:disabled { background: #444; }

        /* ç²å‹å½ˆçª— */
        #winner-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95); color: #222; padding: 40px; border-radius: 30px;
            display: none; flex-direction: column; align-items: center; z-index: 200; box-shadow: 0 0 50px rgba(255,71,87,0.5);
        }
        #winner-popup img { width: 180px; height: 180px; border-radius: 50%; border: 5px solid var(--primary); }
        .reset-btn { margin-top: 20px; padding: 10px 30px; background: #2f3542; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui-panel">
    <h3>æŠ½çæ©Ÿè¨­å®š</h3>
    <input type="file" id="upload-input" multiple accept="image/*">
    <div id="player-list"></div>
    <button id="start-btn" disabled>è«‹å…ˆä¸Šå‚³ç…§ç‰‡</button>
</div>

<div id="winner-popup">
    <h1>ğŸ‰ ä¸­çè€… ğŸ‰</h1>
    <div id="winner-img"></div>
    <h2 id="winner-name"></h2>
    <button class="reset-btn" onclick="resetGame()">æ¸…é™¤çƒé«”é‡æ–°æŒ‘æˆ°</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body } = Matter;

const WORLD_WIDTH = 600;
const WORLD_HEIGHT = 5000;
const BALL_RADIUS = 30;

let engine, render, runner;
let players = [];
let isRunning = false;

function setupPhysics() {
    engine = Engine.create();
    render = Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: window.innerWidth, height: window.innerHeight,
            wireframes: false, background: '#0f0f0f', hasBounds: true
        }
    });

    // å»ºç«‹åœ°åœ–æ©Ÿé—œ
    const walls = [
        Bodies.rectangle(WORLD_WIDTH/2, -20, WORLD_WIDTH, 40, { isStatic: true }),
        Bodies.rectangle(-20, WORLD_HEIGHT/2, 40, WORLD_HEIGHT, { isStatic: true }),
        Bodies.rectangle(WORLD_WIDTH+20, WORLD_HEIGHT/2, 40, WORLD_HEIGHT, { isStatic: true }),
        Bodies.rectangle(WORLD_WIDTH/2, WORLD_HEIGHT + 20, WORLD_WIDTH, 100, { isStatic: true, label: 'finish', render: { fillStyle: '#ffd700' } })
    ];

    const obstacles = [];
    // å¯†é›†é—œå¡è¨­è¨ˆ
    for (let y = 600; y < WORLD_HEIGHT - 600; y += 600) {
        // 1. æ—‹è½‰æ‰‡è‘‰
        for (let i = 0; i < 2; i++) {
            const x = (i === 0) ? 150 : 450;
            const bar = Bodies.rectangle(x, y, 200, 20, { render: { fillStyle: '#ff4757' } });
            const pivot = Constraint.create({ pointA: { x: x, y: y }, bodyB: bar, stiffness: 1 });
            obstacles.push(bar, pivot);
            Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(bar, 0.08));
        }

        // 2. ç§»å‹•æ´»å¡ (æ©«å‘)
        const piston = Bodies.rectangle(WORLD_WIDTH/2, y + 300, 300, 30, { isStatic: true, render: { fillStyle: '#54a0ff' } });
        obstacles.push(piston);
        let t = 0;
        Events.on(engine, 'beforeUpdate', () => {
            t += 0.02;
            Body.setPosition(piston, { x: WORLD_WIDTH/2 + Math.sin(t) * 150, y: y + 300 });
        });

        // 3. é‡˜å­é›²
        for (let j = 0; j < 10; j++) {
            obstacles.push(Bodies.circle(Math.random()*WORLD_WIDTH, y + 450, 8, { isStatic: true, render: { fillStyle: '#444' } }));
        }
    }

    Composite.add(engine.world, [...walls, ...obstacles]);
    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);

    // é¡é ­è·Ÿéš¨
    Events.on(render, 'beforeRender', () => {
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'ball');
        if (balls.length > 0) {
            const lead = balls.reduce((a, b) => a.position.y > b.position.y ? a : b);
            const viewH = render.options.height;
            let top = Math.min(Math.max(0, lead.position.y - viewH * 0.4), WORLD_HEIGHT - viewH);
            render.bounds.min.y = top;
            render.bounds.max.y = top + viewH;
            render.bounds.min.x = 0;
            render.bounds.max.x = WORLD_WIDTH;
        }
    });

    // çµ‚é»åµæ¸¬
    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            if ((p.bodyA.label === 'finish' || p.bodyB.label === 'finish') && isRunning) {
                const ball = p.bodyA.label === 'ball' ? p.bodyA : (p.bodyB.label === 'ball' ? p.bodyB : null);
                if (ball) showWinner(ball);
            }
        });
    });
}

// è™•ç†ç…§ç‰‡èˆ‡åç¨±
document.getElementById('upload-input').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    const list = document.getElementById('player-list');
    for (let file of files) {
        const url = await convertToCircle(file);
        const id = Date.now() + Math.random();
        players.push({ id, url, name: file.name.split('.')[0] });
        
        const div = document.createElement('div');
        div.className = 'player-item';
        div.innerHTML = `<img src="${url}"><input type="text" value="${file.name.split('.')[0]}" onchange="updateName(${id}, this.value)">`;
        list.appendChild(div);
    }
    document.getElementById('start-btn').disabled = false;
    document.getElementById('start-btn').innerText = "åŒæ™‚é‡‹æ”¾ï¼";
});

function updateName(id, val) {
    const p = players.find(p => p.id === id);
    if (p) p.name = val;
}

async function convertToCircle(file) {
    return new Promise(res => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = cvs.height = 200;
                const ctx = cvs.getContext('2d');
                ctx.beginPath(); ctx.arc(100, 100, 100, 0, Math.PI*2); ctx.clip();
                const s = Math.max(200/img.width, 200/img.height);
                ctx.drawImage(img, (200-img.width*s)/2, (200-img.height*s)/2, img.width*s, img.height*s);
                res(cvs.toDataURL());
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

document.getElementById('start-btn').addEventListener('click', () => {
    isRunning = true;
    document.getElementById('ui-panel').style.display = 'none';
    players.forEach((p, i) => {
        const ball = Bodies.circle(WORLD_WIDTH/2 + (i%5*20-40), 100 - (i*50), BALL_RADIUS, {
            restitution: 0.5, label: 'ball',
            render: { sprite: { texture: p.url, xScale: (BALL_RADIUS*2)/200, yScale: (BALL_RADIUS*2)/200 } }
        });
        ball.pName = p.name; ball.pUrl = p.url;
        Composite.add(engine.world, ball);
    });
});

function showWinner(ball) {
    isRunning = false;
    const pop = document.getElementById('winner-popup');
    document.getElementById('winner-img').innerHTML = `<img src="${ball.pUrl}">`;
    document.getElementById('winner-name').innerText = ball.pName;
    pop.style.display = 'flex';
}

function resetGame() {
    // åªç§»é™¤çƒé«”ï¼Œä¸é‡åˆ·ç¶²é 
    const balls = Composite.allBodies(engine.world).filter(b => b.label === 'ball');
    Composite.remove(engine.world, balls);
    document.getElementById('winner-popup').style.display = 'none';
    document.getElementById('ui-panel').style.display = 'block';
    isRunning = false;
}

setupPhysics();
</script>
</body>
</html>
