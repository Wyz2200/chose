<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>物理抽獎 13.0 - 穩定兼容版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --main: #00ffa2; --bg: #050505; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; overflow: hidden; position: fixed; width: 100%; height: 100%; color: #eee; }
        
        #ui-panel { position: fixed; left: 10px; top: 10px; width: calc(100% - 130px); max-height: 50vh; background: rgba(20,20,20,0.95); border-radius: 15px; padding: 15px; z-index: 100; border: 1px solid #444; overflow-y: auto; }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #1a1a1a; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        .player-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #555; background: #333; cursor: pointer; }
        .player-row input { background: transparent; border: none; color: #fff; width: 100%; font-size: 13px; outline: none; }
        
        #btn-start { width: 100%; padding: 12px; background: var(--main); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #add-player { margin-bottom: 10px; background: #333; color: #fff; border: 1px dashed #666; width: 100%; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 12px; }
        
        #leaderboard { position: fixed; right: 10px; top: 10px; width: 100px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 15px; z-index: 100; }
        .rank-item { display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; }
        .rank-item img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--main); }
        
        #win-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 30px; border-radius: 25px; display: none; flex-direction: column; align-items: center; z-index: 200; width: 70%; text-align: center; }
        #win-popup img { width: 150px; height: 150px; border-radius: 50%; border: 5px solid var(--main); margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="ui-panel">
    <div style="font-size: 14px; color: var(--main); margin-bottom: 10px; text-align: center; font-weight: bold;">物理抽獎 13.0</div>
    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">貼上 IG 連結後若頭像未顯示，請點擊頭像框手動換圖。</div>
    <button id="add-player">+ 新增玩家 / 貼上 IG 連結</button>
    <div id="list-area"></div>
    <button id="btn-start" disabled>開始抽獎！</button>
</div>

<div id="leaderboard"><div id="rank-list"></div></div>
<div id="win-popup">
    <div id="win-avatar"></div>
    <h1 id="win-name"></h1>
    <button onclick="location.reload()" style="padding:10px 20px; border-radius:10px; border:none; background:#000; color:#fff;">重新開始</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body } = Matter;
const W = 400, H = 8000; // 縮短一點賽道讓流程更快
let BALL_R = 22, engine, render, players = [], isGaming = false;

function init() {
    engine = Engine.create();
    render = Render.create({
        element: document.body, engine: engine,
        options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: '#050505', hasBounds: true }
    });

    const obs = [];
    for (let y = 600; y < H - 500; y += 400) {
        const x = 100 + Math.random() * 200;
        const tri = Bodies.polygon(x, y, 3, 45, { isStatic: true, render: { fillStyle: '#9c27b0' } });
        obs.push(tri);
        Events.on(engine, 'beforeUpdate', () => Body.setAngle(tri, tri.angle + 0.04));
        // 加入一些擋板確保球不會掉太快
        obs.push(Bodies.rectangle(Math.random()*W, y+200, 120, 20, { isStatic: true, angle: 0.2, render: { fillStyle: '#333' } }));
    }

    const goal = Bodies.rectangle(W/2, H+50, W, 100, { isStatic: true, label: 'goal', render: { fillStyle: '#00ffa2' } });
    Composite.add(engine.world, [
        Bodies.rectangle(-20, H/2, 40, H, { isStatic: true }),
        Bodies.rectangle(W+20, H/2, 40, H, { isStatic: true }),
        goal, ...obs
    ]);

    Render.run(render);
    Runner.run(Runner.create(), engine);

    Events.on(render, 'afterRender', () => {
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'p');
        if (!balls.length) return;
        const sorted = [...balls].sort((a, b) => b.position.y - a.position.y);
        document.getElementById('rank-list').innerHTML = sorted.slice(0, 3).map((b, i) => `
            <div class="rank-item"><img src="${b.pUrl}"><div style="font-size:10px;">${b.pName}</div></div>
        `).join('');
        render.bounds.min.y = Math.min(Math.max(0, sorted[0].position.y - 400), H - 800);
        render.bounds.max.y = render.bounds.min.y + 800;
    });

    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            const b = p.bodyA.label === 'p' ? p.bodyA : (p.bodyB.label === 'p' ? p.bodyB : null);
            if (b && (p.bodyA.label === 'goal' || p.bodyB.label === 'goal') && isGaming) {
                isGaming = false;
                document.getElementById('win-avatar').innerHTML = `<img src="${b.pUrl}">`;
                document.getElementById('win-name').innerText = b.pName;
                document.getElementById('win-popup').style.display = 'flex';
            }
        });
    });
}

// 核心功能：處理 IG 抓取與手動換圖
async function handleInput(el, id) {
    const val = el.value.trim();
    const player = players.find(p => p.id === id);
    if (val.includes('instagram.com')) {
        const user = val.split('instagram.com/')[1]?.split('/')[0]?.split('?')[0];
        if (user) {
            player.name = user; el.value = user;
            // 嘗試抓取
            const imgEl = document.querySelector(`img[data-id="${id}"]`);
            const testUrl = `https://unavatar.io/instagram/${user}`;
            imgEl.src = testUrl; 
            player.url = testUrl;
        }
    } else { player.name = val; }
}

// 點擊頭像手動更換圖片
function triggerFile(id) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const player = players.find(p => p.id === id);
            player.url = ev.target.result;
            document.querySelector(`img[data-id="${id}"]`).src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };
    input.click();
}

function addPlayer(id, url = "https://www.gravatar.com/avatar/0?d=mp", name = "") {
    const d = document.createElement('div');
    d.className = 'player-row';
    d.innerHTML = `
        <img src="${url}" data-id="${id}" onclick="triggerFile(${id})" title="點擊更換圖片">
        <input type="text" value="${name}" placeholder="貼上連結或輸入名字" oninput="handleInput(this, ${id})">
    `;
    document.getElementById('list-area').appendChild(d);
    document.getElementById('btn-start').disabled = false;
}

document.getElementById('add-player').addEventListener('click', () => {
    const id = Math.random();
    players.push({ id, url: "https://www.gravatar.com/avatar/0?d=mp", name: "" });
    addPlayer(id);
});

document.getElementById('btn-start').addEventListener('click', () => {
    isGaming = true; document.getElementById('ui-panel').style.display = 'none';
    players.forEach((p, i) => {
        const b = Bodies.circle(100 + (i%5)*50, 100 - Math.floor(i/5)*50, BALL_R, {
            restitution: 0.5, label: 'p',
            render: { sprite: { texture: p.url, xScale: (BALL_R*2)/150, yScale: (BALL_R*2)/150 } }
        });
        b.pName = p.name || "匿名"; b.pUrl = p.url;
        Composite.add(engine.world, b);
    });
});

init();
</script>
</body>
</html>
