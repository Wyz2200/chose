<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ‚ç´šç‰©ç†æŠ½ç App 4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #0a0a0a; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; color: white; }
        
        /* å´é‚Šè¨­å®šé¢æ¿ */
        #config-panel {
            position: fixed; left: 15px; top: 15px; width: 300px; max-height: 85vh;
            background: rgba(25, 25, 25, 0.9); border-radius: 20px; padding: 20px;
            z-index: 100; overflow-y: auto; border: 1px solid #333; backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: var(--accent); }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #222; padding: 8px; border-radius: 10px; }
        .player-row img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #444; }
        .player-row input { background: #111; border: 1px solid #444; color: white; padding: 5px 10px; border-radius: 5px; flex-grow: 1; }
        
        #go-btn { width: 100%; padding: 15px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-weight: 900; font-size: 18px; cursor: pointer; transition: 0.3s; }
        #go-btn:disabled { background: #333; color: #666; }

        /* ä¸­çå½ˆçª— */
        #win-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #000; padding: 40px; border-radius: 30px;
            display: none; flex-direction: column; align-items: center; z-index: 200;
            box-shadow: 0 0 100px rgba(0,255,136,0.3); text-align: center;
        }
        #win-box img { width: 220px; height: 220px; border-radius: 50%; border: 8px solid var(--accent); margin: 20px 0; }
        .retry-btn { padding: 12px 40px; background: #000; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; }

        canvas { image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
    </style>
</head>
<body>

<div id="config-panel">
    <div class="title">ğŸ† ç‰©ç†æŠ½çå¤§è³½ 4.0</div>
    <input type="file" id="file-selector" multiple accept="image/*" style="margin-bottom: 15px; font-size: 12px;">
    <div id="list-container"></div>
    <button id="go-btn" disabled>ç­‰å¾…ç…§ç‰‡ä¸­...</button>
</div>

<div id="win-box">
    <h3 style="margin:0; color:#555;">WINNER</h3>
    <h1 id="win-name" style="font-size: 40px; margin:10px 0;"></h1>
    <div id="win-photo"></div>
    <button class="retry-btn" onclick="retry()">é‡æ–°æŒ‘æˆ°</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Constraint, Body } = Matter;

let engine, render, runner;
let contestants = [];
let gaming = false;

// åˆå§‹åŒ–ç‰©ç†ä¸–ç•Œ
function initSystem() {
    engine = Engine.create();
    render = Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: window.innerWidth, height: window.innerHeight,
            wireframes: false, background: '#0a0a0a', hasBounds: true
        }
    });

    const W = 600; const H = 5500;
    
    // ç‰†å£èˆ‡å°æµè¨­è¨ˆ (é˜²å¡æ­»é—œéµ)
    const walls = [
        Bodies.rectangle(W/2, -100, W*2, 200, { isStatic: true }), // é ‚
        Bodies.rectangle(-25, H/2, 50, H, { isStatic: true, render: { fillStyle: '#111' } }), // å·¦
        Bodies.rectangle(W+25, H/2, 50, H, { isStatic: true, render: { fillStyle: '#111' } }), // å³
        Bodies.rectangle(W/2, H+50, W, 100, { isStatic: true, label: 'goal', render: { fillStyle: '#00ff88' } }) // çµ‚é»
    ];

    const gear = [];
    // é—œå¡è¨­è¨ˆï¼šç§»é™¤ç´°ç¢é»é»ï¼Œæ”¹ç”¨å¤§é¢ç©å°æµç‰‡
    for (let y = 800; y < H - 500; y += 800) {
        // 1. å¤§å‹æ—‹è½‰è‘‰ç‰‡
        const blade = Bodies.rectangle(W/2, y, 350, 20, { 
            chamfer: { radius: 10 },
            render: { fillStyle: '#333' } 
        });
        const pivot = Constraint.create({ pointA: { x: W/2, y: y }, bodyB: blade, stiffness: 1, length: 0 });
        gear.push(blade, pivot);
        Events.on(engine, 'beforeUpdate', () => Body.setAngularVelocity(blade, 0.05));

        // 2. å·¦å³äº¤æ›¿æ–œå‘æ»‘é“ (ç¢ºä¿çƒä¸æœƒéœæ­¢)
        const isRight = (y / 800) % 2 === 0;
        const ramp = Bodies.rectangle(isRight ? 150 : 450, y + 400, 400, 20, { 
            isStatic: true, angle: isRight ? 0.3 : -0.3,
            chamfer: { radius: 10 },
            render: { fillStyle: '#1a1a1a' }
        });
        gear.push(ramp);
    }

    Composite.add(engine.world, [...walls, ...gear]);
    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);

    // é¡é ­èˆ‡åç¨±é¡¯ç¤º
    Events.on(render, 'afterRender', () => {
        const ctx = render.context;
        const balls = Composite.allBodies(engine.world).filter(b => b.label === 'player');
        
        if (balls.length > 0) {
            const lead = balls.reduce((p, c) => p.position.y > c.position.y ? p : c);
            const vh = render.options.height;
            let ty = Math.min(Math.max(0, lead.position.y - vh * 0.4), H - vh);
            render.bounds.min.y = ty; render.bounds.max.y = ty + vh;
            render.bounds.min.x = 0; render.bounds.max.x = W;

            ctx.font = "bold 18px sans-serif";
            ctx.fillStyle = "#fff";
            ctx.textAlign = "center";
            balls.forEach(b => {
                const sx = (b.position.x - render.bounds.min.x) * (render.canvas.width / W);
                const sy = (b.position.y - render.bounds.min.y) * (render.canvas.height / (render.bounds.max.y - render.bounds.min.y));
                ctx.fillText(b.pName, sx, sy + 50);
            });
        }
    });

    Events.on(engine, 'collisionStart', (e) => {
        e.pairs.forEach(p => {
            if ((p.bodyA.label === 'goal' || p.bodyB.label === 'goal') && gaming) {
                const b = p.bodyA.label === 'player' ? p.bodyA : (p.bodyB.label === 'player' ? p.bodyB : null);
                if (b) finalize(b);
            }
        });
    });
}

// è™•ç†ç…§ç‰‡è£å‰ªèˆ‡é«˜ç•«è³ªè¼¸å‡º
async function makeCircle(file) {
    return new Promise(res => {
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = c.height = 400; // æé«˜å–æ¨£è§£æåº¦æ¸›å°‘é‹¸é½’
                const x = c.getContext('2d');
                x.imageSmoothingEnabled = true;
                x.imageSmoothingQuality = 'high';
                
                x.beginPath(); x.arc(200, 200, 198, 0, Math.PI*2); x.clip();
                const s = Math.max(400/img.width, 400/img.height);
                x.drawImage(img, (400-img.width*s)/2, (400-img.height*s)/2, img.width*s, img.height*s);
                
                // ç•«å¤–æ¡†é˜²æ­¢ç™½é‚Šé‹¸é½’
                x.strokeStyle = "#fff"; x.lineWidth = 4; x.stroke();
                res(c.toDataURL('image/png', 1.0));
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    });
}

document.getElementById('file-selector').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    const container = document.getElementById('list-container');
    for (let f of files) {
        const url = await makeCircle(f);
        const uid = Math.random();
        const name = f.name.split('.')[0];
        contestants.push({ uid, url, name });
        
        const row = document.createElement('div');
        row.className = 'player-row';
        row.innerHTML = `<img src="${url}"><input type="text" value="${name}" oninput="updateContestant(${uid}, this.value)">`;
        container.appendChild(row);
    }
    document.getElementById('go-btn').disabled = false;
    document.getElementById('go-btn').innerText = "é å‚™...ç™¼å°„ï¼";
});

function updateContestant(uid, val) {
    const p = contestants.find(c => c.uid === uid);
    if (p) p.name = val;
}

document.getElementById('go-btn').addEventListener('click', () => {
    gaming = true;
    document.getElementById('config-panel').style.display = 'none';
    contestants.forEach((p, i) => {
        const b = Bodies.circle(300 + (i%3*40-40), 100 - (i*80), 32, {
            restitution: 0.5, friction: 0.001, label: 'player',
            render: { sprite: { texture: p.url, xScale: 64/400, yScale: 64/400 } }
        });
        b.pName = p.name; b.pUrl = p.url;
        Composite.add(engine.world, b);
    });
});

function finalize(b) {
    gaming = false;
    const pop = document.getElementById('win-box');
    document.getElementById('win-photo').innerHTML = `<img src="${b.pUrl}">`;
    document.getElementById('win-name').innerText = b.pName;
    pop.style.display = 'flex';
}

function retry() {
    const balls = Composite.allBodies(engine.world).filter(b => b.label === 'player');
    Composite.remove(engine.world, balls);
    document.getElementById('win-box').style.display = 'none';
    document.getElementById('config-panel').style.display = 'block';
    gaming = false;
}

initSystem();
</script>
</body>
</html>
